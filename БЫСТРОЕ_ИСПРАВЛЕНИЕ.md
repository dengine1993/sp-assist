# üö® –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏

## –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°:

### 1Ô∏è‚É£ –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é (5 –º–∏–Ω—É—Ç)

–û—Ç–∫—Ä–æ–π—Ç–µ: https://supabase.com/dashboard ‚Üí –≤–∞—à –ø—Ä–æ–µ–∫—Ç ‚Üí **SQL Editor**

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç SQL:

```sql
-- –£–¥–∞–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
DROP POLICY IF EXISTS "Allow public insert access to document chunks" ON public.document_chunks;
DROP POLICY IF EXISTS "Allow public read access to document chunks" ON public.document_chunks;
DROP FUNCTION IF EXISTS public.search_similar_chunks(vector(1536), FLOAT, INT, TEXT);
DROP INDEX IF EXISTS public.document_chunks_embedding_idx;

-- –ú–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å —Å 1536 –Ω–∞ 1024
ALTER TABLE public.document_chunks 
ALTER COLUMN embedding TYPE vector(1024);

-- –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å
CREATE INDEX document_chunks_embedding_idx 
ON public.document_chunks 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞
CREATE OR REPLACE FUNCTION public.search_similar_chunks(
  query_embedding vector(1024),
  match_threshold FLOAT DEFAULT 0.7,
  match_count INT DEFAULT 5,
  doc_name TEXT DEFAULT NULL
)
RETURNS TABLE (
  id UUID,
  content TEXT,
  similarity FLOAT,
  metadata JSONB,
  chunk_index INTEGER,
  document_name TEXT
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    document_chunks.id,
    document_chunks.content,
    1 - (document_chunks.embedding <=> query_embedding) AS similarity,
    document_chunks.metadata,
    document_chunks.chunk_index,
    document_chunks.document_name
  FROM public.document_chunks
  WHERE 
    (doc_name IS NULL OR document_chunks.document_name = doc_name)
    AND 1 - (document_chunks.embedding <=> query_embedding) > match_threshold
  ORDER BY document_chunks.embedding <=> query_embedding
  LIMIT match_count;
END;
$$;

-- –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏ RLS
CREATE POLICY "Allow public read access to document chunks"
ON public.document_chunks FOR SELECT
USING (true);

CREATE POLICY "Allow public insert access to document chunks"
ON public.document_chunks FOR INSERT
WITH CHECK (true);

CREATE POLICY "Allow public delete access to document chunks"
ON public.document_chunks FOR DELETE
USING (true);
```

### 2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å JINA_API_KEY (3 –º–∏–Ω—É—Ç—ã)

1. **–ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á**: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ https://jina.ai ‚Üí API Keys ‚Üí Create
2. **–î–æ–±–∞–≤–∏—Ç—å –≤ Supabase**: 
   - Settings ‚Üí Edge Functions ‚Üí Secrets
   - Name: `JINA_API_KEY`
   - Value: `–≤–∞—à_–∫–ª—é—á_–æ—Ç_jina`
   - Add Secret

### 3Ô∏è‚É£ –ü–µ—Ä–µ—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ (1 –º–∏–Ω—É—Ç–∞)

–í Supabase Dashboard:
- Edge Functions ‚Üí `process-pdf` ‚Üí Deploy ‚Üí Redeploy
- Edge Functions ‚Üí `chat` ‚Üí Deploy ‚Üí Redeploy

### 4Ô∏è‚É£ –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ

–í SQL Editor –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```sql
DELETE FROM public.document_chunks;
```

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å .txt —Ñ–∞–π–ª. –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å!

## ‚ùå –í—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Supabase Dashboard ‚Üí Edge Functions ‚Üí process-pdf ‚Üí Logs

–ò—â–∏—Ç–µ –æ—à–∏–±–∫–∏ —Ç–∏–ø–∞:
- `JINA_API_KEY is not configured` ‚Üí –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ —à–∞–≥—É 2
- `dimension mismatch` ‚Üí –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ —à–∞–≥—É 1
- `rate limit` ‚Üí –ø–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞
