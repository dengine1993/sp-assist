# Исправление ошибки загрузки текстовых файлов

## Проблема
При загрузке .txt файлов возникает ошибка "Edge Function returned a non-2xx status code".

## Причины
1. **Несоответствие размерности векторов**: База данных настроена на векторы размерности 1536 (для OpenAI), но Edge Function использует Jina AI embeddings с размерностью 1024
2. **Отсутствует API ключ**: Не настроен `JINA_API_KEY` для Edge Function

## Решение

### Шаг 1: Применить миграцию базы данных

1. Откройте [Supabase Dashboard](https://supabase.com/dashboard)
2. Выберите ваш проект: `xcfywgwbzisuflngcwme`
3. Перейдите в раздел **SQL Editor** (в левом меню)
4. Нажмите **New Query**
5. Скопируйте содержимое файла `supabase/migrations/20251008000000_fix_embedding_dimension.sql`
6. Вставьте в редактор SQL и нажмите **Run**

### Шаг 2: Настроить JINA_API_KEY

1. Получите API ключ Jina AI:
   - Зарегистрируйтесь на [https://jina.ai](https://jina.ai)
   - Перейдите в раздел API Keys
   - Создайте новый ключ

2. Настройте ключ в Supabase:
   - В Supabase Dashboard откройте раздел **Settings** → **Edge Functions**
   - Найдите секцию **Secrets**
   - Добавьте новый секрет:
     - Name: `JINA_API_KEY`
     - Value: ваш API ключ от Jina AI
   - Нажмите **Add Secret**

### Шаг 3: Проверить другие необходимые секреты

Убедитесь, что также настроены:
- `LOVABLE_API_KEY` - для работы чата (получить на [lovable.dev](https://lovable.dev))
- `SUPABASE_URL` - обычно настраивается автоматически
- `SUPABASE_SERVICE_ROLE_KEY` - обычно настраивается автоматически

### Шаг 4: Переразвернуть Edge Functions

После настройки секретов нужно переразвернуть Edge Functions:

1. В Supabase Dashboard перейдите в **Edge Functions**
2. Найдите функцию `process-pdf`
3. Нажмите **Deploy** → **Redeploy**
4. Повторите для функции `chat`

### Шаг 5: Очистить старые данные (опционально)

Если у вас уже были загружены документы со старой размерностью, их нужно удалить:

1. В Supabase Dashboard откройте **SQL Editor**
2. Выполните запрос:
   ```sql
   DELETE FROM public.document_chunks;
   ```
3. Загрузите документы заново

## Проверка

После выполнения всех шагов:
1. Откройте приложение
2. Попробуйте загрузить .txt файл
3. Проверьте, что загрузка проходит успешно

## Дополнительная информация

### Размерности векторов
- **OpenAI text-embedding-3-small**: 1536 измерений
- **Jina AI jina-embeddings-v3**: 1024 измерения (по умолчанию)

### Проверка логов
Если ошибка сохраняется, проверьте логи Edge Function:
1. Supabase Dashboard → **Edge Functions** → `process-pdf`
2. Вкладка **Logs**
3. Найдите последние запросы и ошибки

## Контакты для поддержки
Если проблема не решена, проверьте:
- Консоль браузера (F12) - для ошибок на клиенте
- Логи Edge Functions - для ошибок на сервере
- Наличие всех необходимых API ключей

