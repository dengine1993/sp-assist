# 🔍 Техническая диагностика проблемы

## 📊 Визуальная схема проблемы

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПРОБЛЕМА: Ошибка загрузки                    │
└─────────────────────────────────────────────────────────────────┘

┌──────────────────┐         ┌──────────────────┐         ┌──────────────────┐
│   Браузер        │         │  Edge Function   │         │  База данных     │
│  (Frontend)      │         │  (process-pdf)   │         │  (PostgreSQL)    │
└────────┬─────────┘         └────────┬─────────┘         └────────┬─────────┘
         │                            │                            │
         │  1. Загрузка .txt         │                            │
         ├──────────────────────────>│                            │
         │                            │                            │
         │                            │  2. Создание embeddings   │
         │                            │     (Jina AI v3)          │
         │                            │     Размерность: 1024     │
         │                            │                            │
         │                            │  3. Попытка сохранить     │
         │                            ├──────────────────────────>│
         │                            │     vector(1024)           │
         │                            │                            │
         │                            │  ❌ ОШИБКА!               │
         │                            │  Таблица требует:          │
         │                            │  vector(1536)              │
         │                            │<──────────────────────────┤
         │                            │                            │
         │  ❌ "non-2xx status"       │                            │
         │<──────────────────────────┤                            │
         │                            │                            │
```

## 🔴 Корневая причина #1: Несоответствие размерностей

### Что было:
```sql
-- Таблица создана для OpenAI embeddings
CREATE TABLE document_chunks (
  embedding vector(1536),  -- ❌ OpenAI размерность
  ...
);

-- Функция поиска также использует 1536
CREATE FUNCTION search_similar_chunks(
  query_embedding vector(1536),  -- ❌ Неправильно
  ...
)
```

### Что используется:
```typescript
// Edge Function использует Jina AI
const response = await fetch('https://api.jina.ai/v1/embeddings', {
  body: JSON.stringify({
    model: 'jina-embeddings-v3',  // ✅ Создает vector(1024)
    input: [text],
  })
});
```

### Конфликт:
```
Jina AI v3 → создает вектор размера 1024
PostgreSQL → ожидает вектор размера 1536
Результат → ОШИБКА при попытке INSERT
```

## 🔴 Корневая причина #2: Отсутствие API ключа

```typescript
// В Edge Function:
const jinaApiKey = Deno.env.get('JINA_API_KEY');
if (!jinaApiKey) {
  throw new Error('JINA_API_KEY is not configured'); // ❌
}
```

**Проблема:** Переменная окружения `JINA_API_KEY` не установлена в Supabase Edge Functions.

---

## ✅ Решение

### Часть 1: Исправление размерности

```
МИГРАЦИЯ:
┌────────────────────────────────────────────────┐
│ 1. Удаление зависимостей                       │
│    DROP FUNCTION search_similar_chunks         │
│    DROP INDEX document_chunks_embedding_idx    │
│                                                │
│ 2. Изменение размерности                       │
│    ALTER COLUMN embedding TYPE vector(1024)    │
│                                                │
│ 3. Пересоздание индекса                        │
│    CREATE INDEX ... USING ivfflat              │
│                                                │
│ 4. Пересоздание функции                        │
│    CREATE FUNCTION ... vector(1024)            │
└────────────────────────────────────────────────┘
```

### Часть 2: Настройка API ключа

```
СЕКРЕТЫ SUPABASE:
┌────────────────────────────────────────────────┐
│ Settings → Edge Functions → Secrets            │
│                                                │
│ [+] Add Secret                                 │
│     Name:  JINA_API_KEY                        │
│     Value: jina_xxxxxxxxxxxxx                  │
└────────────────────────────────────────────────┘
```

---

## 📈 Схема работы после исправления

```
┌──────────────────┐         ┌──────────────────┐         ┌──────────────────┐
│   Браузер        │         │  Edge Function   │         │  База данных     │
│  (Frontend)      │         │  (process-pdf)   │         │  (PostgreSQL)    │
└────────┬─────────┘         └────────┬─────────┘         └────────┬─────────┘
         │                            │                            │
         │  1. Загрузка .txt         │                            │
         ├──────────────────────────>│                            │
         │                            │                            │
         │                            │  ✅ JINA_API_KEY найден   │
         │                            │                            │
         │                            │  2. Создание embeddings   │
         │                            │     (Jina AI v3)          │
         │                            │     Размерность: 1024     │
         │                            │                            │
         │                            │  3. Сохранение             │
         │                            ├──────────────────────────>│
         │                            │     vector(1024)           │
         │                            │                            │
         │                            │  ✅ УСПЕХ!                │
         │                            │  Таблица принимает:        │
         │                            │  vector(1024)              │
         │                            │<──────────────────────────┤
         │                            │                            │
         │  ✅ "Успешно загружено"    │                            │
         │<──────────────────────────┤                            │
         │                            │                            │
```

---

## 🔬 Детальный анализ компонентов

### Компонент 1: Frontend (DocumentUploader.tsx)
```typescript
// Строки 59-64
const { data, error } = await supabase.functions.invoke('process-pdf', {
  body: {
    pdfText: text,          // ✅ Текст файла
    documentName: documentName.trim()  // ✅ Название документа
  }
});
```
**Статус:** ✅ Работает корректно

---

### Компонент 2: Edge Function (process-pdf/index.ts)

#### Проблема A: API ключ
```typescript
// Строка 71
const jinaApiKey = Deno.env.get('JINA_API_KEY');
if (!jinaApiKey) {
  throw new Error('JINA_API_KEY is not configured'); // ❌ Ошибка
}
```
**Решение:** Добавить JINA_API_KEY в секреты

#### Проблема B: Размерность
```typescript
// Строки 34-44
async function createEmbedding(text: string, apiKey: string): Promise<number[]> {
  const response = await fetch('https://api.jina.ai/v1/embeddings', {
    body: JSON.stringify({
      model: 'jina-embeddings-v3',  // Создает 1024-мерный вектор
      input: [text],
    })
  });
  return data.data[0].embedding;  // Возвращает number[1024]
}
```
**Статус:** ✅ Функция работает правильно, но вектор не подходит для БД

---

### Компонент 3: База данных (PostgreSQL + pgvector)

#### Проблема: Таблица
```sql
-- Миграция 20251007095340_...sql (строка 8)
CREATE TABLE public.document_chunks (
  embedding vector(1536),  -- ❌ Требует 1536 измерений
  ...
);
```
**Решение:** ALTER COLUMN embedding TYPE vector(1024)

#### Проблема: Функция поиска
```sql
-- Строки 26-27
CREATE FUNCTION public.search_similar_chunks(
  query_embedding vector(1536),  -- ❌ Неправильная размерность
  ...
)
```
**Решение:** Пересоздать функцию с vector(1024)

#### Проблема: Индекс
```sql
-- Строка 16
CREATE INDEX document_chunks_embedding_idx 
ON public.document_chunks 
USING ivfflat (embedding vector_cosine_ops);
```
**Решение:** Пересоздать индекс после изменения типа

---

## 🧪 Тестирование

### Тест 1: Проверка размерности
```sql
-- После миграции выполните:
SELECT 
  column_name, 
  data_type, 
  udt_name
FROM information_schema.columns
WHERE table_name = 'document_chunks' 
  AND column_name = 'embedding';

-- Ожидаемый результат:
-- column_name | data_type | udt_name
-- embedding   | USER-DEFINED | vector

-- Проверка размерности:
SELECT pg_typeof(embedding) 
FROM document_chunks 
LIMIT 1;

-- Ожидаемый результат: vector(1024)
```

### Тест 2: Проверка API ключа
```bash
# В логах Edge Function должно быть:
Creating embedding for chunk (length: ...)

# НЕ должно быть:
JINA_API_KEY is not configured
```

### Тест 3: Проверка вставки
```sql
-- После загрузки документа:
SELECT 
  document_name,
  COUNT(*) as chunks_count,
  AVG(array_length(embedding::float[], 1)) as avg_dimension
FROM document_chunks
GROUP BY document_name;

-- Ожидаемый результат:
-- avg_dimension должно быть 1024
```

---

## 📚 Справочная информация

### Размерности популярных моделей embeddings

| Модель | Размерность | Использование |
|--------|-------------|---------------|
| OpenAI text-embedding-3-small | 1536 | ❌ Не используется |
| OpenAI text-embedding-3-large | 3072 | ❌ Не используется |
| **Jina AI v3** | **1024** | **✅ Используется** |
| Jina AI v2 | 768 | ❌ Не используется |
| Cohere embed-multilingual-v3 | 1024 | ❌ Не используется |

### Ссылки на документацию

- [Jina AI Embeddings](https://jina.ai/embeddings/)
- [pgvector Extension](https://github.com/pgvector/pgvector)
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)
- [PostgreSQL Vector Types](https://github.com/pgvector/pgvector#vector-types)

---

## 📝 История изменений

| Дата | Что было | Что стало |
|------|----------|-----------|
| 2025-10-07 | Создана таблица с vector(1536) | - |
| 2025-10-08 | Обнаружена ошибка загрузки | - |
| 2025-10-08 | Создана миграция | vector(1024) |
| 2025-10-08 | Создана документация | FIX_UPLOAD_ERROR.md |

---

**Автор диагностики:** AI Assistant  
**Дата:** 2025-10-08  
**Версия документа:** 1.0

