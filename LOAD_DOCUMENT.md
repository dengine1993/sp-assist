# Инструкция по загрузке документа СП 60.13330.2020

Этот документ описывает процесс загрузки и индексации документа СП 60.13330.2020 в векторную базу данных для работы RAG-системы.

## Предварительные требования

1. **Node.js** версии 18 или выше
2. **Supabase проект** с настроенной базой данных (миграции уже применены)
3. **OpenAI API ключ** для создания embeddings
4. **OpenRouter API ключ** для работы с DeepSeek

## Настройка переменных окружения

Убедитесь, что в файле `.env` присутствуют следующие переменные:

```env
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=your-anon-key
```

А в настройках Supabase Edge Functions (Supabase Dashboard → Project Settings → Edge Functions):

```env
OPENAI_API_KEY=sk-...
OPENROUTER_API_KEY=sk-...
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

## Способ 1: Загрузка из PDF (рекомендуется)

Этот способ автоматически извлекает текст из PDF файла.

### Шаги:

1. Убедитесь, что PDF файл находится в `public/sp-60-13330-2020.pdf`

2. Установите зависимости (если еще не установлены):
   ```bash
   npm install
   ```

3. Запустите скрипт загрузки:
   ```bash
   npm run load-sp-pdf
   ```

4. Скрипт выполнит следующие действия:
   - Извлечет текст из всех страниц PDF
   - Разобьет текст на смысловые фрагменты (chunks)
   - Создаст векторные embeddings для каждого фрагмента через OpenAI API
   - Загрузит все данные в Supabase

5. Процесс может занять 5-15 минут в зависимости от размера документа.

## Способ 2: Загрузка из TXT (упрощенный)

Если у вас возникли проблемы с PDF или вы хотите использовать уже конвертированный текст:

### Шаги:

1. Конвертируйте PDF в TXT:
   - Используйте любой онлайн-конвертер (например, pdf2txt, Adobe Acrobat)
   - Или командную строку: `pdftotext sp-60-13330-2020.pdf sp-60-13330-2020.txt`

2. Сохраните TXT файл как `public/sp-60-13330-2020.txt`

3. Установите зависимости:
   ```bash
   npm install
   ```

4. Запустите упрощенный скрипт:
   ```bash
   npm run load-sp-txt
   ```

5. Скрипт обработает текстовый файл и загрузит в базу данных.

## Проверка результата

После успешной загрузки вы увидите сообщение:

```
✨ Готово! Документ успешно загружен и проиндексирован.
   Теперь DeepSeek будет искать ответы в этом документе.
```

### Проверка в Supabase:

1. Откройте Supabase Dashboard
2. Перейдите в Table Editor → `document_chunks`
3. Вы должны увидеть множество записей с `document_name = 'sp-60-13330-2020'`

### Проверка в приложении:

1. Запустите приложение: `npm run dev`
2. Откройте http://localhost:5173
3. Вы увидите индикатор "Документ проиндексирован" в верхней части
4. Задайте вопрос по СП 60.13330.2020, например:
   - "Какие требования к температуре в жилых помещениях?"
   - "Расскажи о нормах воздухообмена"
   - "Как рассчитывается теплопотери?"

DeepSeek будет искать ответы в предзагруженном документе и отвечать на основе его содержимого.

## Переиндексация документа

Если вам нужно обновить документ или переиндексировать его:

1. Просто запустите скрипт заново
2. Старые фрагменты автоматически удалятся
3. Документ будет проиндексирован с нуля

## Устранение проблем

### Ошибка: "VITE_SUPABASE_URL is not configured"
- Проверьте наличие файла `.env` в корне проекта
- Убедитесь, что переменные правильно записаны

### Ошибка: "OPENAI_API_KEY is not configured"
- Проверьте настройки Edge Functions в Supabase Dashboard
- Добавьте переменную `OPENAI_API_KEY` в секреты Edge Functions

### Ошибка при извлечении текста из PDF
- Попробуйте Способ 2 (загрузка из TXT)
- Убедитесь, что PDF файл не поврежден
- Проверьте, что PDF содержит текст (не отсканированные изображения)

### Процесс останавливается на середине
- Проверьте лимиты OpenAI API (возможно, исчерпана квота)
- Уменьшите размер батча в `process-pdf/index.ts` (batchSize)

## Дополнительная информация

### Как работает система:

1. **Chunking**: Документ разбивается на фрагменты ~1000 символов
2. **Embeddings**: Каждый фрагмент конвертируется в вектор размерностью 1536
3. **Vector Search**: При запросе создается embedding вопроса и ищутся похожие фрагменты
4. **RAG**: Найденные фрагменты передаются в контекст DeepSeek для генерации ответа

### Настройка параметров:

В файле `supabase/functions/chat/index.ts` можно настроить:
- `match_threshold` (0.7) - порог схожести для поиска
- `match_count` (5) - количество возвращаемых фрагментов

В файле `supabase/functions/process-pdf/index.ts`:
- `maxChunkSize` (1000) - размер фрагмента в символах
- `batchSize` (5) - количество одновременно обрабатываемых фрагментов

## Поддержка

Если возникли вопросы или проблемы:
1. Проверьте логи в консоли браузера и терминала
2. Проверьте логи Edge Functions в Supabase Dashboard → Edge Functions → Logs
3. Убедитесь, что все API ключи действительны

